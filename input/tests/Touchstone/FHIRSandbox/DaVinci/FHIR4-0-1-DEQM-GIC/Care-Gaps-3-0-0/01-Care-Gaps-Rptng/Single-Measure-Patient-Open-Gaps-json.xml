<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir">
	<id value="Single-Measure-Patient-Open-Gaps-json"/>
	<meta>
		<profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
	</meta>

	<text>
		<status value="generated"/>
		<div xmlns="http://www.w3.org/1999/xhtml"><p>Single-Measure-Patient-Open-Gaps-json</p></div>
	</text>	
	
	<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-rule">
		<extension url="ruleId">
			<valueId value="assertParam"/>
		</extension>
		<extension url="path">
			<valueString value="./_reference/rule/assertParam.groovy"/>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="periodStart"/>
			</extension>
			<extension url="value">
				<valueString value="${periodStartRequest}"/>
			</extension>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="periodEnd"/>
			</extension>
			<extension url="value">
				<valueString value="${periodEndRequest}"/>
			</extension>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="status"/>
			</extension>
			<extension url="value">
				<valueString value="${statusRequest}"/>
			</extension>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="subject"/>
			</extension>
			<extension url="value">
				<valueString value="${subjectRequest}"/>
			</extension>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="organization"/>
			</extension>
			<extension url="value">
				<valueString value="${organizationRequest}"/>
			</extension>
		</extension>
		<extension url="param">
			<extension url="name">
				<valueString value="practitioner"/>
			</extension>
			<extension url="value">
				<valueString value="${practitionerRequest}"/>
			</extension>
		</extension>
	</extension>
	
	<url value="http://wildfhir.aegis.net/fhir4-0-1/TestScript/Single-Measure-Patient-Open-Gaps-json"/>
	<name value="Single-Measure-Patient-Open-Gaps-json"/>

	<status value="active"/>
	<date value="2021-06-22"/>
	<publisher value="AEGIS.net, Inc."/>
	<contact>
		<name value="Touchstone Support"/>
		<telecom>
			<system value="email"/>
			<value value="Touchstone_Support@aegis.net"/>
			<use value="work"/>
		</telecom>
	</contact>
	<description value="As a practitioner, get all gaps for a patient. All $care-gaps operations are performed using the FHIR Operation Framework HTTP GET method with url inline parameters. Preconditions: Server knows the patient and has measure data for the patient."/>
	<copyright value="(c) AEGIS.net, Inc. 2019"/>

	<origin>
		<index value="1" />
		<profile>
			<system value="http://hl7.org/fhir/testscript-profile-origin-types" />
			<code value="FHIR-Client" />
		</profile>
	</origin>
	
	<destination>
		<index value="1" />
		<profile>
			<system value="http://hl7.org/fhir/testscript-profile-destination-types" />
			<code value="FHIR-Server" />
		</profile>
	</destination>

	<profile id="ParametersProfileBase">
		<reference value="http://hl7.org/fhir/StructureDefinition/Parameters" />
	</profile>

	<variable>
		<name value="PatientId"/>
		<defaultValue value="gaps-patient01"/>
		<description value="Enter a resource id for a valid Patient on the destination system."/>
		<hint value="[Valid Patient Id]"/>
	</variable>
	<variable>
		<name value="MeasureId1"/>
		<defaultValue value="measure-exm130-example"/>
		<description value="Enter a resource id for a valid Measure on the destination system."/>
		<hint value="[Valid Measure Id]"/>
	</variable>
	<variable>
		<name value="periodStartValue"/>
		<defaultValue value="2019-01-01"/>
		<description value="The start of a gaps through period."/>
	</variable>
	<variable>
		<name value="periodEndValue"/>
		<defaultValue value="2019-12-31"/>
		<description value="The end of a gaps through period."/>
	</variable>

	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="periodStart"/>
		</extension>
		<name value="periodStartRequest"/>
		<sourceId value="paramRequest"/>
	</variable>
	
	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="periodEnd"/>
		</extension>
		<name value="periodEndRequest"/>
		<sourceId value="paramRequest"/>
	</variable>
	
	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="status"/>
		</extension>
		<name value="statusRequest"/>
		<sourceId value="paramRequest"/>
	</variable>
	
	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="subject"/>
		</extension>
		<name value="subjectRequest"/>
		<sourceId value="paramRequest"/>
	</variable>
	
	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="organization"/>
		</extension>
		<name value="organizationRequest"/>
		<sourceId value="paramRequest"/>
	</variable>
	
	<variable>
		<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-variable-paramField">
			<valueString value="practitioner"/>
		</extension>
		<name value="practitionerRequest"/>
		<sourceId value="paramRequest"/>
	</variable>

	<test id="Single-Measure-Patient-Open-Gaps-json">
		<name value="Single-Measure-Patient-Open-Gaps-json"/>
		<description value="Query for the gaps in care for a patient using HTTP GET. Expected response is 200 (OK)."/>
		<action>
			<operation>
				<type>
					<system value="http://touchstone.com/fhir/testscript-operation-codes-extended"/>
					<code value="care-gaps"/>
				</type>
				<resource value="Measure"/>
				<description value="Run the $care-gaps operation for a patient."/>
				<accept value="json"/>
				<contentType value="json"/>
				<destination value="1" />
				<encodeRequestUrl value="true"/>
				<method value="get"/>
				<origin value="1" />
				<params value="/$care-gaps?periodStart=${periodStartValue}&amp;periodEnd=${periodEndValue}&amp;subject=Patient/${PatientId}&amp;measureId=${MeasureId1}&amp;status=open-gap"/>
				<requestId value="paramRequest"/>
			</operation>
		</action>
		<action>
			<assert>
				<description value="Confirm that the request HTTP Header Accept format is the FHIR mime-type 'application/fhir+json'."/>
				<direction value="request"/>
				<headerField value="Accept"/>
				<operator value="contains"/>
				<value value="application/fhir+json"/>
				<warningOnly value="false" />
			</assert>
		</action>
		<action>
			<assert>
				<description value="Confirm that the request HTTP Header Accept contains 'charset=utf-8'."/>
				<direction value="request"/>
				<headerField value="Accept"/>
				<operator value="contains"/>
				<value value="charset=utf-8"/>
				<warningOnly value="true"/>
			</assert>
		</action>
		<action>
			<assert>
				<description value="Confirm that the request HTTP Header Content-Type format is the FHIR mime-type 'application/fhir+json'."/>
				<direction value="request"/>
				<headerField value="Content-Type"/>
				<operator value="contains"/>
				<value value="application/fhir+json"/>
				<warningOnly value="false" />
			</assert>
		</action>		
		<action>
			<assert>
				<description value="Confirm that the request HTTP Header Content-Type contains 'charset=utf-8'."/>
				<direction value="request"/>
				<headerField value="Content-Type"/>
				<operator value="contains"/>
				<value value="charset=utf-8"/>
				<warningOnly value="true"/>
			</assert>
		</action>
		<action>
			<assert>
				<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-rule">
					<extension url="ruleId">
						<valueId value="assertParam"/>
					</extension>
				</extension>
				<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail"> 
                    <valueBoolean value="false"/> 
                </extension>
				<direction value="response" />
				<warningOnly value="false" />
			</assert>
		</action>
		<action>
			<assert>
				<description value="Confirm that the returned HTTP status is 200(OK)."/>
				<direction value="response" />
				<operator value="in"/>
				<responseCode value="200"/>
				<warningOnly value="false" />
			</assert>
		</action>
		<action>
			<assert>
				<description value="Confirm that the response HTTP Header Content-Type format is the FHIR mime-type 'application/fhir+json'."/>
				<direction value="response"/>
				<headerField value="Content-Type"/>
				<operator value="contains"/>
				<value value="application/fhir+json"/>
				<warningOnly value="true" />
			</assert>
		</action>		
		<action>
			<assert>
				<description value="Confirm that the response HTTP Header Content-Type contains 'charset=utf-8'."/>
				<direction value="response"/>
				<headerField value="Content-Type"/>
				<operator value="contains"/>
				<value value="charset=utf-8"/>
				<warningOnly value="true"/>
			</assert>
		</action>
		<action>
			<assert>
				<description value="Confirm that the response body contains a Parameters"/>
				<direction value="response" />
				<resource value="Parameters"/>
				<warningOnly value="false" />
			</assert>
		</action>
		<action>
			<assert>
				<extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail"> 
                    <valueBoolean value="false"/> 
                </extension>
				<description value="Validate the response Parameters."/>
				<direction value="response" />
				<validateProfileId value="ParametersProfileBase"/>
				<warningOnly value="false" />
			</assert>
		</action>	
	</test>
</TestScript>